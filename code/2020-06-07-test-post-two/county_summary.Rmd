---
author: 
date: "`r Sys.Date()`"
output: html_document
params: 
  output_dir: "../2020-06-07-test-post-two"
  county: "New Haven"
  return_url: "index.html"
title: "Covid-19 Summary for `r params$county` County"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# see this StackOverflow tip for info on how to set title via parameter:
#    https://stackoverflow.com/questions/31861569/setting-document-title-in-rmarkdown-from-parameters
```
```{r library, echo = FALSE, message = FALSE}
library(tidyverse)
library(sparkline)
library(kableExtra)
library(formattable)
```
```{r setup_town_info, echo = FALSE}
path_to_post <- "~/Dropbox/Programming/R_Stuff/can_i_blog_too/content/post/2020-03-29-covid19-cases-in-connecticut/"
path_to_ctcorona <- "~/Documents/R_local_repos/ctcorona/data/"
path_to_post_june <- "~/Dropbox/Programming/R_Stuff/can_i_blog_too/content/post/2020-06-22-tracking-covid-19-in-connecticut/"
path_to_static_june <- "~/Dropbox/Programming/R_Stuff/can_i_blog_too/static/post/2020-06-22-tracking-covid-19-in-connecticut/"

load(paste0(path_to_ctcorona, "dph_datasets.RData"))
load(paste0(path_to_ctcorona, "census_population.RData"))
```

This table summarizes trends in each town in `r params$county` County. 
It is sorted by the category of town as
developed in the report [The Five Connecticuts](https://ctdatahaven.org/sites/ctdatahaven/files/UConnCPR%20Changing%20Demographics-5%20CTs%202004.pdf):
Urban Core, Urban Periphery, Wealthy, Suburban, and Rural.

For each town it shows the population, the percentage of deaths in that town
attributed to nursing home residents, and the largest average number of daily new cases per 100K of population
(based on rolling 14 day average). 

Next there are a series of [sparklines](https://en.wikipedia.org/wiki/Sparkline)
that show the trend in daily new cases and daily deaths (based on 
14 day moving average). Cases and deaths are shown as a ratio to population
in the town. 
(The per-cases number basically tells you the value associated with the maximum height of the sparkline.)

The purpose of this table is to make it easier to quickly scan
for trends in local towns.

```{r sparkline_ranges, echo  = FALSE}
county_cases_max <- max(dph_counties$rnew_cases_per1k, na.rm = TRUE) * 100
county_deaths_max <- max(dph_counties$rnew_deaths_per1k, na.rm = TRUE) * 100
town_cases_max <- max(dph_towns$rnew_cases_per1k, na.rm = TRUE) * 100
town_cases_max <- 1.0 * 100 # Somers is 2 and Montville is 1.06 
town_deaths_max <- max(dph_towns$rnew_deaths_per1k, na.rm = TRUE) * 100

```

For the county sparklines, maximum range for cases is `r round(county_cases_max,1)`
maximum range for deaths is `r round(county_deaths_max, 1)`

For towns, maximum range for cases is `r round(town_cases_max, 1)`
maximum range for deaths is `r round(town_deaths_max, 1)`


```{r, echo = FALSE, results = "asis"}
# THE ORIGINAL VERSION
# based on https://stackoverflow.com/questions/54244718/combining-sparkline-in-kableextra-table
# jQuery sparklines https://omnipotent.net/jquery.sparkline/#s-docs
county_sparklines <- dph_counties %>% 
  group_by(county) %>% 
  summarise(`daily cases` = spk_chr(rnew_cases_per1k, chartRangeMin = 0,
                                     chartRangeMax = county_cases_max),
            `daily deaths` = spk_chr(rnew_deaths_per1k, chartRangeMin = 0,
                                     chartRangeMax = county_deaths_max), .groups = "drop")

county_summary <- dph_counties %>% 
  filter(county == params$county)
county_summary <- county_summary %>% 
  # left_join(town_info %>% select(county, category, town)) %>% 
  group_by(county) %>% 
  # summarise(`max cases` = round(max(rnew_cases, na.rm = TRUE)),
  summarise(`max cases` = (max(rnew_cases_per1k, na.rm = TRUE) %>% round(4)),
    # `county cases` = spk_chr(rnew_cases_per1k, chartRangeMin = 0, 
    #                        chartRangeMax = county_cases_max),
    # `county deaths` = spk_chr(rnew_deaths_per1k, chartRangeMin = 0, 
    #                        chartRangeMax = county_deaths_max), 
    .groups = "drop") %>% 
  left_join(county_sparklines, by = "county") %>% 
  left_join(county_info %>% select(county, total_pop), by = "county") %>% 
  # left_join(town_with_nursing %>% 
  #             filter(date == max(date)) %>% 
  #             select(town, nh_death_pct), by = "town") %>% 
  mutate(nh_death_pct = NA_real_, category = "") %>% 
  select(county, category, county, total_pop, nh_death_pct, `max cases`, `daily cases`,
         `daily deaths`) %>% 
  mutate(total_pop = comma(total_pop, digits = 0), 
         nh_death_pct = percent(nh_death_pct, digits = 0)) %>% 
  formattable::format_table(
    # x = .,
    # formatters = list(align=c("l")),
    format = "html",
    align = c("l", "l", "l", "l", "c", "c", "c", "c")
  ) %>%
  # kable_styling("striped", full_width = F) %>%
  # kable_styling(full_width = F) %>%
  # group_rows("group1", 1, 2) %>%
  # group_rows("group1", 1, 2) %>%
  # group_rows("group2", 3,3) %>%
  htmltools::HTML() %>%
  shiny::div() %>%
  sparkline::spk_add_deps()


town_summary <- dph_towns %>%
  filter(county == params$county, #total_pop > 10000,
         !is.na(rnew_cases)) # %>%
town_summary <- town_summary %>% 
  # left_join(town_info %>% select(county, category, town)) %>% 
  group_by(county, category, town) %>% 
  # summarise(`max cases` = round(max(rnew_cases, na.rm = TRUE)),
  summarise(`max cases` = (max(rnew_cases_per1k * 100, na.rm = TRUE) %>% round(1)),
    `town cases` = spk_chr(rnew_cases_per1k*100, chartRangeMin = 0, 
                           chartRangeMax = town_cases_max),
    `town deaths` = spk_chr(rnew_deaths_per1k*100, chartRangeMin = 0, 
                           chartRangeMax = town_deaths_max), .groups = "drop") %>% 
  left_join(county_sparklines, by = "county") %>% 
  left_join(town_info %>% select(town, total_pop), by = "town") %>% 
  left_join(town_with_nursing %>% 
              filter(date == max(date)) %>% 
              select(town, nh_death_pct), by = "town") %>% 
  select(town, category, total_pop, `max cases`, nh_death_pct, `town cases`,
         `town deaths`) %>% 
  mutate(total_pop = comma(total_pop, digits = 0),
                  nh_death_pct = percent(nh_death_pct, digits = 0)) %>% 
  # use col.names to get column names in format_table
  formattable::format_table(
    # x = .,
    # formatters = list(align=c("l")),
    format = "html",
    align = c("l", "l", "l", "c", "c")
  ) %>%
  # kable_styling("striped", full_width = F) %>%
  # kable_styling(full_width = F) %>%
  # group_rows("group1", 1, 2) %>%
  # group_rows("group1", 1, 2) %>%
  # group_rows("group2", 3,3) %>%
  htmltools::HTML() %>%
  shiny::div() %>%
  sparkline::spk_add_deps()
county_summary
town_summary
```



